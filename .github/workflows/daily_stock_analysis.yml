name: æ¯æ—¥å°è‚¡åˆ†æ-Gmailé€šçŸ¥

on:
  schedule:
    # æ¯å¤© UTC 09:15 æ‰§è¡Œ = å°æ¹¾æ—¶é—´ä¸‹åˆ 17:15 (UTC+8)
    - cron: '0 8 * * *'
  
  workflow_dispatch:
    inputs:
      send_email:
        description: 'æ˜¯å¦å‘é€ Email é€šçŸ¥'
        required: false
        default: false
        type: boolean

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk chromium-browser chromium-chromedriver
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Ensure data directories exist
        run: |
          mkdir -p StockTSEHTML StockOTCHTML StockInfo StockTSEHistory StockOTCHistory
      
      - name: Run stock analysis
        env:
          TZ: 'Asia/Taipei'
          DEBUG_MODE: 'false'  # æ”¹æˆ 'true' å¯ç”¨é™¤é”™æ¨¡å¼ (è·³è¿‡çˆ¬è™«å’Œ History)
        run: |
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "âš¡ é™¤é”™æ¨¡å¼:è·³è¿‡çˆ¬è™«å’Œ History ç”Ÿæˆ"
            python stock_workflow.py --debug-skip-data-processing --copy-to-repo
          else
            echo "ğŸš€ å®Œæ•´æµç¨‹æ¨¡å¼"
            python stock_workflow.py --copy-to-repo
          fi
      
      - name: Verify files in StockInfo directory
        run: |
          echo "ğŸ“¦ æ£€æŸ¥ StockInfo èµ„æ–™å¤¹çš„æ¡£æ¡ˆ..."
          
          # æ£€æŸ¥ StockInfo èµ„æ–™å¤¹
          if [ -d "StockInfo" ]; then
            echo "ğŸ“‹ StockInfo èµ„æ–™å¤¹å†…å®¹:"
            ls -lh StockInfo/
          else
            echo "âŒ StockInfo èµ„æ–™å¤¹ä¸å­˜åœ¨!"
          fi
          
          # æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
          echo ""
          echo "ğŸ“¦ æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶..."
          if [ -f "StockTSEHistory/stock_tse.db" ]; then
            echo "âœ… stock_tse.db å­˜åœ¨ ($(ls -lh StockTSEHistory/stock_tse.db | awk '{print $5}'))"
          else
            echo "âš ï¸  stock_tse.db ä¸å­˜åœ¨"
          fi
          
          if [ -f "StockOTCHistory/stock_otc.db" ]; then
            echo "âœ… stock_otc.db å­˜åœ¨ ($(ls -lh StockOTCHistory/stock_otc.db | awk '{print $5}'))"
          else
            echo "âš ï¸  stock_otc.db ä¸å­˜åœ¨"
          fi
      
      - name: Package analysis results
        run: |
          # åˆ›å»ºæ—¥æœŸæ ‡è®°
          DATE=$(TZ=Asia/Taipei date +'%Y%m%d')
          DATETIME=$(TZ=Asia/Taipei date +'%Y-%m-%d %H:%M')
          
          # æ‰“åŒ…æ‰€æœ‰åˆ†æç»“æœ
          mkdir -p release_package
          
          # å¤åˆ¶ Excel æŠ¥è¡¨ï¼ˆä» StockInfo ç›®å½•ï¼‰
          cp -f StockInfo/*.xlsx release_package/ 2>/dev/null || true
          
          # å¤åˆ¶ HTML å›¾è¡¨ï¼ˆä» StockInfo ç›®å½•ï¼‰
          cp -f StockInfo/*.html release_package/ 2>/dev/null || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ -z "$(ls -A release_package 2>/dev/null)" ]; then
            echo "âš ï¸  è­¦å‘Š: release_package ç›®å½•ä¸ºç©ºï¼Œæ²¡æœ‰æ–‡ä»¶å¯ä»¥æ‰“åŒ…"
            echo "ğŸ“‚ StockInfo ç›®å½•å†…å®¹:"
            ls -lh StockInfo/ 2>/dev/null || echo "StockInfo ç›®å½•ä¸å­˜åœ¨"
            # åˆ›å»ºä¸€ä¸ªç©ºçš„ zip æ–‡ä»¶ä»¥é¿å…åç»­æ­¥éª¤å¤±è´¥
            touch release_package/README.txt
            echo "æœ¬æ¬¡æ‰§è¡Œæœªç”Ÿæˆåˆ†ææ–‡ä»¶" > release_package/README.txt
          fi
          
          # åˆ›å»ºå‹ç¼©æ¡£
          cd release_package
          zip -r ../stock-analysis-${DATE}.zip . -x "*.git*"
          cd ..
          
          echo "DATE=${DATE}" >> $GITHUB_ENV
          echo "DATETIME=${DATETIME}" >> $GITHUB_ENV
          
          # æ˜¾ç¤ºæ‰“åŒ…å†…å®¹
          echo "æ‰“åŒ…å†…å®¹:"
          unzip -l stock-analysis-${DATE}.zip | head -20
      
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: analysis-${{ env.DATE }}
          name: è‚¡ç¥¨åˆ†ææŠ¥å‘Š ${{ env.DATETIME }}
          body: |
            ## ğŸ“Š å°è‚¡åˆ†ææŠ¥å‘Š
            
            **åˆ†ææ—¶é—´:** ${{ env.DATETIME }}
            
            ### ğŸ“¦ ä¸‹è½½å†…å®¹
            - âœ… ä¸Šå¸‚åˆ†ææŠ¥è¡¨ (tse_analysis_result.xlsx)
            - âœ… ä¸ŠæŸœåˆ†ææŠ¥è¡¨ (otc_analysis_result.xlsx)
            - âœ… æ‰€æœ‰ HTML äº’åŠ¨å›¾è¡¨
            - âœ… æ‰€æœ‰ PNG é™æ€å›¾è¡¨
            
            ### ğŸ“ˆ åˆ†ææŒ‡æ ‡
            - æˆäº¤é‡å¼‚å¸¸åˆ†æ
            - æ³•äººä¹°å–è¶…ç»Ÿè®¡
            - æ¶¨è·Œå¹…æ’è¡Œ
            - æŠ€æœ¯æŒ‡æ ‡åˆ†æ
            
            ---
            
            âš ï¸ æ­¤ release ä¼šåœ¨ 30 å¤©åè‡ªåŠ¨åˆ é™¤
          files: |
            StockInfo/tse_analysis_result.xlsx
            StockInfo/otc_analysis_result.xlsx
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get Release URL
        run: |
          REPO="${{ github.repository }}"
          TAG="analysis-${{ env.DATE }}"
          RELEASE_URL="https://github.com/${REPO}/releases/tag/${TAG}"
          echo "RELEASE_URL=${RELEASE_URL}" >> $GITHUB_ENV
          echo "ğŸ” Release URL: ${RELEASE_URL}"
      
      - name: Remove source code archives from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: analysis-${{ env.DATE }}
        run: |
          # ç­‰å¾… release å®Œå…¨åˆ›å»º
          sleep 5
          
          # ä½¿ç”¨ GitHub API åˆ é™¤ source code å‹ç¼©æ¡£
          REPO="${{ github.repository }}"
          
          # è·å– release ID
          RELEASE_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}" | \
            jq -r '.id')
          
          if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
            # è·å–æ‰€æœ‰ assets
            ASSETS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${REPO}/releases/${RELEASE_ID}/assets")
            
            # åˆ é™¤ source code å‹ç¼©æ¡£
            echo "$ASSETS" | jq -r '.[] | select(.name | test("^(Source code|æºä»£ç ).*\\.(zip|tar\\.gz)$")) | .id' | while read asset_id; do
              if [ -n "$asset_id" ]; then
                echo "ğŸ—‘ï¸  åˆ é™¤ source code asset: $asset_id"
                curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                  "https://api.github.com/repos/${REPO}/releases/assets/${asset_id}"
              fi
            done
            
            echo "âœ… å·²ç§»é™¤ source code å‹ç¼©æ¡£"
          else
            echo "âš ï¸  æ‰¾ä¸åˆ° release ID"
          fi
      
      - name: Send Email with Attachments
        if: ${{ github.event_name == 'schedule' || inputs.send_email == true }}
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          # å®‰è£… Python é‚®ä»¶å¥—ä»¶
          pip install secure-smtplib
          
          # åˆ›å»ºå‘é€é‚®ä»¶çš„ Python è„šæœ¬
          cat > send_email.py << 'EOF'
          import smtplib
          import os
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.base import MIMEBase
          from email import encoders
          
          def send_email():
              sender_email = os.environ.get('GMAIL_USER')
              sender_password = os.environ.get('GMAIL_PASSWORD')
              recipient_email_primary = os.environ.get('RECIPIENT_EMAIL')
              release_url = os.environ.get('RELEASE_URL')
              date_str = os.environ.get('DATE')
              datetime_str = os.environ.get('DATETIME')
              
              # å¤šä¸ªæ”¶ä»¶äºº
              recipients = [
                  recipient_email_primary,
                  'i07250717@gmail.com',
                  'hospital691202@yahoo.com.tw',
                  'miacomtw@yahoo.com.tw',
                  'a0932973234@gmail.com',
                  'energy8916@hotmail.com'
              ]
              recipients_str = ', '.join(recipients)
              
              # åˆ›å»ºé‚®ä»¶
              msg = MIMEMultipart()
              msg['From'] = sender_email
              msg['To'] = recipients_str
              msg['Subject'] = f'ğŸ“Š å°è‚¡æ¯æ—¥åˆ†ææŠ¥å‘Š - {datetime_str}'
              
              # é‚®ä»¶å†…å®¹ (HTMLæ ¼å¼)
              body = f"""
          <html>
            <head>
              <style>
                body {{
                  font-family: 'Segoe UI', Arial, sans-serif;
                  line-height: 1.6;
                  color: #333;
                  max-width: 800px;
                  margin: 0 auto;
                  padding: 20px;
                }}
                .download-section {{
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  padding: 30px;
                  border-radius: 12px;
                  margin: 20px 0;
                  text-align: center;
                }}
                .download-title {{
                  color: white;
                  font-size: 20px;
                  font-weight: bold;
                  margin-bottom: 15px;
                }}
                .download-btn {{
                  display: inline-block;
                  padding: 15px 40px;
                  background-color: white;
                  color: #667eea;
                  text-decoration: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                }}
                .info-box {{
                  background: white;
                  padding: 20px;
                  border-radius: 8px;
                  margin: 20px 0;
                  border-left: 4px solid #667eea;
                }}
              </style>
            </head>
            <body>
              <h2 style="color: #667eea;">ğŸ“Š å°è‚¡æ¯æ—¥åˆ†ææŠ¥å‘Š</h2>
              
              <p><strong>åˆ†ææ—¶é—´:</strong> {datetime_str}</p>
              <div class="info-box">
                <h3 style="color: #667eea; margin-top: 0;">ğŸ” é‚®ä»¶é™„ä»¶</h3>
                <ul style="margin: 10px 0;">
                  <li style="margin: 8px 0;">âœ… <strong>tse_analysis_result.xlsx</strong> - ä¸Šå¸‚è‚¡ç¥¨åˆ†ææŠ¥è¡¨(å®Œæ•´èµ„æ–™)</li>
                  <li style="margin: 8px 0;">âœ… <strong>otc_analysis_result.xlsx</strong> - ä¸ŠæŸœè‚¡ç¥¨åˆ†ææŠ¥è¡¨(å®Œæ•´èµ„æ–™)</li>
                  <li style="margin: 8px 0;">âœ… <strong>ALL_TSE.html</strong> - ä¸Šå¸‚å®Œæ•´åˆ†ææŠ¥å‘Š(äº’åŠ¨å¼)</li>
                  <li style="margin: 8px 0;">âœ… <strong>ALL_OTC.html</strong> - ä¸ŠæŸœå®Œæ•´åˆ†ææŠ¥å‘Š(äº’åŠ¨å¼)</li>
                </ul>
                <p style="color: #666; font-size: 14px; margin-top: 15px;">
                  ğŸ’¡ Excel ä½¿ç”¨ Excel å¼€å¯,HTML ä½¿ç”¨æµè§ˆå™¨å¼€å¯æŸ¥çœ‹äº’åŠ¨å›¾è¡¨
                </p>
              </div>
              
              <div class="info-box">
                <h3 style="color: #667eea; margin-top: 0;">ğŸ“ˆ åˆ†æå†…å®¹</h3>
                <ul style="margin: 10px 0;">
                  <li>âœ… æˆäº¤é‡å¼‚å¸¸åˆ†æ(æ ‡å‡†å·®æ£€æµ‹)</li>
                  <li>âœ… ä¸‰å¤§æ³•äººä¹°å–è¶…ç»Ÿè®¡</li>
                  <li>âœ… æ¶¨è·Œå¹…æ’è¡Œæ¦œ</li>
                  <li>âœ… æŠ€æœ¯æŒ‡æ ‡åˆ†æå›¾è¡¨</li>
                  <li>âœ… æ±‡æ•´åˆ†æä¸å€¼å¾—è§‚å¯Ÿè‚¡ç¥¨</li>
                </ul>
              </div>
              
              <p style="margin-top: 30px; color: #666; font-size: 12px; text-align: center; padding-top: 20px; border-top: 1px solid #eee;">
                ğŸ¤– æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨äº§ç”Ÿ<br>
                ğŸ“… ç”Ÿæˆæ—¶é—´: {datetime_str}
              </p>
            </body>
          </html>
          """
              
              msg.attach(MIMEText(body, 'html', 'utf-8'))
              
              # é™„åŠ æ¡£æ¡ˆ(åŒ…å« complete.html)
              files_to_attach = [
                  'StockInfo/tse_analysis_result.xlsx',
                  'StockInfo/otc_analysis_result.xlsx',
                  'StockInfo/ALL_TSE.html',
                  'StockInfo/ALL_OTC.html'
              ]
              
              for filename in files_to_attach:
                  if os.path.exists(filename):
                      with open(filename, 'rb') as f:
                          part = MIMEBase('application', 'octet-stream')
                          part.set_payload(f.read())
                          encoders.encode_base64(part)
                          part.add_header(
                              'Content-Disposition',
                              f'attachment; filename= {os.path.basename(filename)}'
                          )
                          msg.attach(part)
                          print(f'âœ… é™„åŠ æ¡£æ¡ˆ: {filename}')
                  else:
                      print(f'âš ï¸  æ¡£æ¡ˆä¸å­˜åœ¨: {filename}')
              
              # å‘é€é‚®ä»¶
              try:
                  server = smtplib.SMTP('smtp.gmail.com', 587)
                  server.starttls()
                  server.login(sender_email, sender_password)
                  server.send_message(msg)
                  server.quit()
                  print(f'âœ… é‚®ä»¶å·²æˆåŠŸå‘é€åˆ°: {recipients_str}')
              except Exception as e:
                  print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {str(e)}')
                  raise
          
          if __name__ == '__main__':
              send_email()
          EOF
          
          # æ‰§è¡Œå‘é€é‚®ä»¶
          python send_email.py
      
      - name: Commit stock data to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "ğŸ“‹ å‡†å¤‡æäº¤çš„æ¡£æ¡ˆåˆ—è¡¨:"
          echo ""
          
          # æ£€æŸ¥æ¡£æ¡ˆæ˜¯å¦å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥ StockInfo èµ„æ–™å¤¹çš„æ¡£æ¡ˆ:"
          ls -lh StockInfo/ || echo "âš ï¸  StockInfo èµ„æ–™å¤¹ä¸å­˜åœ¨"
          echo ""
          
          # å¼ºåˆ¶åŠ å…¥æ‰€æœ‰æ¡£æ¡ˆ(ä½¿ç”¨ --force å¿½ç•¥ .gitignore)
          echo "ğŸ“¦ åŠ å…¥æ¡£æ¡ˆåˆ° Git staging area..."
          
          # åŠ å…¥ CSV åŸå§‹èµ„æ–™
          git add -f StockTSEDaily/*.csv 2>/dev/null || true
          git add -f StockTSEShares/*.csv 2>/dev/null || true
          git add -f StockOTCDaily/*.csv 2>/dev/null || true
          git add -f StockOTCShares/*.csv 2>/dev/null || true
          
          # ğŸ†• åŠ å…¥æ•°æ®åº“æ–‡ä»¶
          echo "ğŸ“¦ åŠ å…¥æ•°æ®åº“æ–‡ä»¶..."
          git add -f StockTSEHistory/stock_tse.db 2>/dev/null || true
          git add -f StockOTCHistory/stock_otc.db 2>/dev/null || true
          git add -f StockInfo/stock_tse_all.db 2>/dev/null || true
          git add -f StockInfo/stock_otc_all.db 2>/dev/null || true
          
          # åŠ å…¥ StockInfo èµ„æ–™å¤¹çš„æ‰€æœ‰æ¡£æ¡ˆ
          echo "ğŸ“¦ åŠ å…¥ StockInfo èµ„æ–™å¤¹çš„æ¡£æ¡ˆ..."
          
          # ä¸å¸¦æ—¥æœŸçš„æ¡£æ¡ˆ
          git add -f StockInfo/tse_analysis_result.xlsx 2>/dev/null || true
          git add -f StockInfo/otc_analysis_result.xlsx 2>/dev/null || true
          git add -f StockInfo/tse_analysis_result_complete.html 2>/dev/null || true
          git add -f StockInfo/otc_analysis_result_complete.html 2>/dev/null || true
          git add -f StockInfo/ALL_TSE.html 2>/dev/null || true
          git add -f StockInfo/ALL_OTC.html 2>/dev/null || true
          git add -f StockInfo/TSE_buy_ranking.txt 2>/dev/null || true
          git add -f StockInfo/OTC_buy_ranking.txt 2>/dev/null || true
          
          # ä¿é™©æªæ–½:ç¡®ä¿æ‰€æœ‰ HTML éƒ½è¢«åŠ å…¥
          git add -f StockInfo/*.html 2>/dev/null || true
          
          echo ""
          echo "ğŸ“¦ Git staging area ä¸­çš„æ¡£æ¡ˆ:"
          git diff --staged --name-status
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "âŒ æ²¡æœ‰æ¡£æ¡ˆå˜æ›´,è·³è¿‡æäº¤"
            echo ""
            echo "ğŸ” é™¤é”™èµ„è®¯:"
            echo "StockInfo ç›®å½•å†…å®¹:"
            ls -la StockInfo/ 2>/dev/null || echo "StockInfo ä¸å­˜åœ¨"
            echo ""
            echo "æ•°æ®åº“æ–‡ä»¶:"
            ls -lh StockTSEHistory/stock_tse.db StockOTCHistory/stock_otc.db 2>/dev/null || echo "History æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨"
            ls -lh StockInfo/stock_tse_all.db StockInfo/stock_otc_all.db 2>/dev/null || echo "StockInfo æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨"
            echo ""
            echo "Git çŠ¶æ€:"
            git status
          else
            echo "âœ… å‘ç°æ¡£æ¡ˆå˜æ›´,å‡†å¤‡æäº¤..."
            echo ""
            
            # æäº¤å¹¶æ¨é€
            git commit -m "ğŸ“Š æ›´æ–°è‚¡ç¥¨èµ„æ–™ä¸æ•°æ®åº“ $(TZ=Asia/Taipei date +'%Y-%m-%d %H:%M')"
            git push
            
            echo ""
            echo "âœ… æˆåŠŸæ¨é€èµ„æ–™åˆ° repository"
            echo ""
            echo "ğŸ“‚ å·²æ›´æ–°çš„æ¡£æ¡ˆ:"
            git diff HEAD~1 --name-only | while read file; do
              echo "   âœ“ $file"
            done
          fi
      
      - name: Clean old releases (keep last 30 days)
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 7
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}