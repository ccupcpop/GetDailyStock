name: æ¯æ—¥å°è‚¡åˆ†æ-Gmailé€šçŸ¥

on:
  schedule:
    # æ¯å¤© UTC 09:15 åŸ·è¡Œ = å°ç£æ™‚é–“ä¸‹åˆ 17:15 (UTC+8)
    - cron: '30 8 * * *'
  
  workflow_dispatch:

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk chromium-browser chromium-chromedriver
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Ensure data directories exist
        run: |
          mkdir -p StockHTML StockPNG StockOTCHTML StockOTCPNG
      
      - name: Run stock analysis
        env:
          TZ: 'Asia/Taipei'
        run: |
          python ä¸Šå¸‚ä¸Šæ«ƒå…¨æµç¨‹.py
      
      - name: Package analysis results
        run: |
          # å‰µå»ºæ—¥æœŸæ¨™è¨˜
          DATE=$(TZ=Asia/Taipei date +'%Y%m%d')
          DATETIME=$(TZ=Asia/Taipei date +'%Y-%m-%d %H:%M')
          
          # æ‰“åŒ…æ‰€æœ‰åˆ†æçµæœ
          mkdir -p release_package
          
          # è¤‡è£½ Excel å ±è¡¨
          cp -f *.xlsx release_package/ 2>/dev/null || true
          
          # è¤‡è£½ HTML å’Œ PNG åœ–è¡¨
          cp -f StockHTML/*.html release_package/ 2>/dev/null || true
          cp -f StockPNG/*.png release_package/ 2>/dev/null || true
          cp -f StockOTCHTML/*.html release_package/ 2>/dev/null || true
          cp -f StockOTCPNG/*.png release_package/ 2>/dev/null || true
          
          # å‰µå»ºå£“ç¸®æª”
          cd release_package
          zip -r ../stock-analysis-${DATE}.zip . -x "*.git*"
          cd ..
          
          echo "DATE=${DATE}" >> $GITHUB_ENV
          echo "DATETIME=${DATETIME}" >> $GITHUB_ENV
          
          # é¡¯ç¤ºæ‰“åŒ…å…§å®¹
          echo "æ‰“åŒ…å…§å®¹:"
          unzip -l stock-analysis-${DATE}.zip | head -20
      
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: analysis-${{ env.DATE }}
          name: è‚¡ç¥¨åˆ†æå ±å‘Š ${{ env.DATETIME }}
          body: |
            ## ğŸ“Š å°è‚¡åˆ†æå ±å‘Š
            
            **åˆ†ææ™‚é–“:** ${{ env.DATETIME }}
            
            ### ğŸ“¦ ä¸‹è¼‰å…§å®¹
            - âœ… ä¸Šå¸‚åˆ†æå ±è¡¨ (analysis_result.xlsx)
            - âœ… ä¸Šæ«ƒåˆ†æå ±è¡¨ (otc_analysis_result.xlsx)
            - âœ… æ‰€æœ‰ HTML äº’å‹•åœ–è¡¨
            - âœ… æ‰€æœ‰ PNG éœæ…‹åœ–è¡¨
            
            ### ğŸ“ˆ åˆ†ææŒ‡æ¨™
            - æˆäº¤é‡ç•°å¸¸åˆ†æ
            - æ³•äººè²·è³£è¶…çµ±è¨ˆ
            - æ¼²è·Œå¹…æ’è¡Œ
            - æŠ€è¡“æŒ‡æ¨™åˆ†æ
            
            ---
            
            âš ï¸ æ­¤ release æœƒåœ¨ 30 å¤©å¾Œè‡ªå‹•åˆªé™¤
          files: |
            stock-analysis-${{ env.DATE }}.zip
            analysis_result.xlsx
            otc_analysis_result.xlsx
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get Release URL
        run: |
          REPO="${{ github.repository }}"
          TAG="analysis-${{ env.DATE }}"
          RELEASE_URL="https://github.com/${REPO}/releases/tag/${TAG}"
          echo "RELEASE_URL=${RELEASE_URL}" >> $GITHUB_ENV
          echo "ğŸ“ Release URL: ${RELEASE_URL}"
      
      - name: Remove source code archives from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: analysis-${{ env.DATE }}
        run: |
          # ç­‰å¾… release å®Œå…¨å‰µå»º
          sleep 5
          
          # ä½¿ç”¨ GitHub API åˆªé™¤ source code å£“ç¸®æª”
          REPO="${{ github.repository }}"
          
          # ç²å– release ID
          RELEASE_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}" | \
            jq -r '.id')
          
          if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
            # ç²å–æ‰€æœ‰ assets
            ASSETS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${REPO}/releases/${RELEASE_ID}/assets")
            
            # åˆªé™¤ source code å£“ç¸®æª”
            echo "$ASSETS" | jq -r '.[] | select(.name | test("^(Source code|æºä»£ç¢¼).*\\.(zip|tar\\.gz)$")) | .id' | while read asset_id; do
              if [ -n "$asset_id" ]; then
                echo "ğŸ—‘ï¸  åˆªé™¤ source code asset: $asset_id"
                curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                  "https://api.github.com/repos/${REPO}/releases/assets/${asset_id}"
              fi
            done
            
            echo "âœ… å·²ç§»é™¤ source code å£“ç¸®æª”"
          else
            echo "âš ï¸  æ‰¾ä¸åˆ° release ID"
          fi
      
      - name: Send Email with Attachments
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          # å®‰è£ Python éƒµä»¶å¥—ä»¶å’Œè³‡æ–™è™•ç†å¥—ä»¶
          pip install secure-smtplib pandas openpyxl
          
          # å‰µå»ºç™¼é€éƒµä»¶çš„ Python è…³æœ¬
          cat > send_email.py << 'EOF'
          import smtplib
          import os
          import pandas as pd
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.base import MIMEBase
          from email import encoders
          from datetime import datetime
          
          def read_summary_data():
              """è®€å–å½™æ•´åˆ†æçš„è²·è¶…å’Œè³£è¶…è³‡æ–™"""
              tables_html = ""
              
              try:
                  # è®€å–ä¸Šå¸‚å½™æ•´åˆ†æ
                  df_all_tse = pd.read_excel('StockInfo/analysis_result.xlsx', sheet_name='å½™æ•´åˆ†æ', header=None)
                  
                  # æ‰¾åˆ°è²·è¶…æ¨™é¡Œè¡Œ
                  buy_header_row = None
                  for idx in range(len(df_all_tse)):
                      row_vals = df_all_tse.iloc[idx].tolist()
                      if any(pd.notna(v) and 'è­‰åˆ¸ä»£è™Ÿ' in str(v) for v in row_vals):
                          buy_header_row = idx
                          break
                  
                  # æ‰¾åˆ°è³£è¶…æ¨™é¡Œè¡Œ
                  sell_header_row = None
                  for idx in range(buy_header_row + 1, len(df_all_tse)):
                      row_vals = df_all_tse.iloc[idx].tolist()
                      if any(pd.notna(v) and 'è³£è¶…' in str(v) and 'ã€' in str(v) for v in row_vals):
                          # æ‰¾åˆ°è³£è¶…çš„è³‡æ–™æ¨™é¡Œè¡Œ
                          for j in range(idx + 1, min(idx + 5, len(df_all_tse))):
                              row_vals2 = df_all_tse.iloc[j].tolist()
                              if any(pd.notna(v) and 'è­‰åˆ¸ä»£è™Ÿ' in str(v) for v in row_vals2):
                                  sell_header_row = j
                                  break
                          break
                  
                  # æå–è²·è¶…è³‡æ–™
                  if buy_header_row is not None and sell_header_row is not None:
                      df_buy_tse = df_all_tse.iloc[buy_header_row:sell_header_row-2].copy()
                      df_buy_tse.columns = df_buy_tse.iloc[0]
                      df_buy_tse = df_buy_tse[1:].reset_index(drop=True)
                      df_buy_tse = df_buy_tse[df_buy_tse.iloc[:, 0].notna()]
                      
                      # æå–è³£è¶…è³‡æ–™
                      df_sell_tse = df_all_tse.iloc[sell_header_row:].copy()
                      df_sell_tse.columns = df_sell_tse.iloc[0]
                      df_sell_tse = df_sell_tse[1:].reset_index(drop=True)
                      df_sell_tse = df_sell_tse[df_sell_tse.iloc[:, 0].notna()]
                      
                      # ç”Ÿæˆä¸Šå¸‚è²·è¶…è¡¨æ ¼
                      tables_html += """
                      <h2 style="color: #2c3e50; margin-top: 30px; padding: 15px; background: white; border-radius: 8px; border-left: 5px solid #e53935;">
                        ğŸ”´ ä¸Šå¸‚è‚¡ç¥¨ (TSE) - Taiwan Stock Exchange
                      </h2>
                      
                      <div style="background: linear-gradient(135deg, #e53935 0%, #c62828 100%); padding: 15px; border-radius: 10px 10px 0 0; margin-top: 20px;">
                        <h3 style="color: white; margin: 0;">ğŸ”º æœ€è¿‘5å¤©è²·è¶…å½™æ•´åˆ†æ</h3>
                      </div>
                      """ + df_buy_tse.to_html(index=False, border=0, justify='left', classes='buy-table') + """
                      
                      <div style="background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%); padding: 15px; border-radius: 10px 10px 0 0; margin-top: 30px;">
                        <h3 style="color: white; margin: 0;">ğŸ”» æœ€è¿‘5å¤©è³£è¶…å½™æ•´åˆ†æ</h3>
                      </div>
                      """ + df_sell_tse.to_html(index=False, border=0, justify='left', classes='sell-table')
                  
                  # è®€å–ä¸Šæ«ƒå½™æ•´åˆ†æ
                  df_all_otc = pd.read_excel('StockInfo/otc_analysis_result.xlsx', sheet_name='å½™æ•´åˆ†æ', header=None)
                  
                  # æ‰¾åˆ°è²·è¶…æ¨™é¡Œè¡Œ
                  buy_header_row_otc = None
                  for idx in range(len(df_all_otc)):
                      row_vals = df_all_otc.iloc[idx].tolist()
                      if any(pd.notna(v) and 'è­‰åˆ¸ä»£è™Ÿ' in str(v) for v in row_vals):
                          buy_header_row_otc = idx
                          break
                  
                  # æ‰¾åˆ°è³£è¶…æ¨™é¡Œè¡Œ
                  sell_header_row_otc = None
                  for idx in range(buy_header_row_otc + 1, len(df_all_otc)):
                      row_vals = df_all_otc.iloc[idx].tolist()
                      if any(pd.notna(v) and 'è³£è¶…' in str(v) and 'ã€' in str(v) for v in row_vals):
                          for j in range(idx + 1, min(idx + 5, len(df_all_otc))):
                              row_vals2 = df_all_otc.iloc[j].tolist()
                              if any(pd.notna(v) and 'è­‰åˆ¸ä»£è™Ÿ' in str(v) for v in row_vals2):
                                  sell_header_row_otc = j
                                  break
                          break
                  
                  # æå–ä¸Šæ«ƒè²·è¶…è³£è¶…è³‡æ–™
                  if buy_header_row_otc is not None:
                      if sell_header_row_otc:
                          df_buy_otc = df_all_otc.iloc[buy_header_row_otc:sell_header_row_otc-2].copy()
                      else:
                          df_buy_otc = df_all_otc.iloc[buy_header_row_otc:].copy()
                      
                      df_buy_otc.columns = df_buy_otc.iloc[0]
                      df_buy_otc = df_buy_otc[1:].reset_index(drop=True)
                      df_buy_otc = df_buy_otc[df_buy_otc.iloc[:, 0].notna()]
                      
                      tables_html += """
                      <h2 style="color: #2c3e50; margin-top: 50px; padding: 15px; background: white; border-radius: 8px; border-left: 5px solid #43a047;">
                        ğŸŸ¢ ä¸Šæ«ƒè‚¡ç¥¨ (OTC) - Taipei Exchange
                      </h2>
                      
                      <div style="background: linear-gradient(135deg, #e53935 0%, #c62828 100%); padding: 15px; border-radius: 10px 10px 0 0; margin-top: 20px;">
                        <h3 style="color: white; margin: 0;">ğŸ”º æœ€è¿‘5å¤©è²·è¶…å½™æ•´åˆ†æ</h3>
                      </div>
                      """ + df_buy_otc.to_html(index=False, border=0, justify='left', classes='buy-table')
                      
                      if sell_header_row_otc:
                          df_sell_otc = df_all_otc.iloc[sell_header_row_otc:].copy()
                          df_sell_otc.columns = df_sell_otc.iloc[0]
                          df_sell_otc = df_sell_otc[1:].reset_index(drop=True)
                          df_sell_otc = df_sell_otc[df_sell_otc.iloc[:, 0].notna()]
                          
                          tables_html += """
                          <div style="background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%); padding: 15px; border-radius: 10px 10px 0 0; margin-top: 30px;">
                            <h3 style="color: white; margin: 0;">ğŸ”» æœ€è¿‘5å¤©è³£è¶…å½™æ•´åˆ†æ</h3>
                          </div>
                          """ + df_sell_otc.to_html(index=False, border=0, justify='left', classes='sell-table')
                  
              except Exception as e:
                  print(f'âš ï¸  è®€å–å½™æ•´åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}')
                  import traceback
                  traceback.print_exc()
                  tables_html = "<p style='color: #f57c00;'>âš ï¸ ç„¡æ³•è®€å–çµ±è¨ˆè³‡æ–™</p>"
              
              return tables_html
          
          def send_email():
              # å¾ç’°å¢ƒè®Šæ•¸è®€å–è¨­å®š
              sender_email = os.environ.get('GMAIL_USER')
              sender_password = os.environ.get('GMAIL_PASSWORD')
              recipient_email = os.environ.get('RECIPIENT_EMAIL')
              release_url = os.environ.get('RELEASE_URL')
              date_str = os.environ.get('DATE')
              datetime_str = os.environ.get('DATETIME')
              
              # è®€å–çµ±è¨ˆè³‡æ–™
              statistics_tables = read_summary_data()
              
              # å‰µå»ºéƒµä»¶
              msg = MIMEMultipart()
              msg['From'] = sender_email
              msg['To'] = recipient_email
              msg['Subject'] = f'ğŸ“Š å°è‚¡åˆ†æå ±å‘Š {datetime_str}'
              
              # éƒµä»¶å…§å®¹
              body = f"""
          <html>
            <head>
              <style>
                body {{ 
                  font-family: 'Microsoft JhengHei', Arial, sans-serif;
                  line-height: 1.6;
                  color: #333;
                  background-color: #f5f5f5;
                }}
                .download-section {{
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  padding: 30px;
                  border-radius: 12px;
                  margin: 20px 0;
                  text-align: center;
                }}
                .download-title {{
                  color: white;
                  font-size: 20px;
                  font-weight: bold;
                  margin-bottom: 15px;
                }}
                .download-btn {{
                  display: inline-block;
                  padding: 15px 40px;
                  background-color: white;
                  color: #667eea;
                  text-decoration: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                }}
                .buy-table, .sell-table {{
                  border-collapse: collapse;
                  width: 100%;
                  margin: 0 0 20px 0;
                  font-size: 13px;
                  background: white;
                }}
                .buy-table th, .sell-table th {{
                  background-color: #495057;
                  color: white;
                  padding: 12px 10px;
                  text-align: left;
                  font-weight: bold;
                  border-right: 1px solid rgba(255,255,255,0.1);
                }}
                .buy-table td {{
                  padding: 10px;
                  border-bottom: 1px solid #e9ecef;
                }}
                .sell-table td {{
                  padding: 10px;
                  border-bottom: 1px solid #e9ecef;
                }}
                .buy-table tr:nth-child(even) {{
                  background-color: #fff5f5;
                }}
                .buy-table tr:nth-child(odd) {{
                  background-color: #ffffff;
                }}
                .sell-table tr:nth-child(even) {{
                  background-color: #f1f8f4;
                }}
                .sell-table tr:nth-child(odd) {{
                  background-color: #ffffff;
                }}
                .buy-table tr:hover, .sell-table tr:hover {{
                  background-color: #f8f9fa;
                }}
                .section-title {{
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  padding: 15px 20px;
                  border-radius: 8px;
                  margin-top: 30px;
                  font-size: 18px;
                }}
              </style>
            </head>
            <body>
              <h2 style="color: #667eea;">ğŸ“Š å°è‚¡æ¯æ—¥åˆ†æå ±å‘Š</h2>
              
              <p><strong>åˆ†ææ™‚é–“:</strong> {datetime_str}</p>
              
              <div class="download-section">
                <div class="download-title">ğŸ“¦ å®Œæ•´å ±å‘Šä¸‹è¼‰</div>
                <a href="{release_url}" class="download-btn">
                  ğŸ”— ä¸‹è¼‰å®Œæ•´åˆ†æåŒ… (å«æ‰€æœ‰åœ–è¡¨)
                </a>
                <p style="color: white; margin-top: 15px; font-size: 14px; opacity: 0.9;">
                  åŒ…å«: Excel å ±è¡¨ â€¢ HTML äº’å‹•åœ–è¡¨ â€¢ PNG éœæ…‹åœ–è¡¨
                </p>
              </div>
              
              <hr style="margin: 30px 0; border: none; border-top: 2px solid #ddd;">
              
              {statistics_tables}
              
              <hr style="margin: 40px 0; border: none; border-top: 1px solid #ddd;">
              
              <div class="section-title">ğŸ“ é™„ä»¶æª”æ¡ˆ</div>
              <ul style="margin-top: 15px; background: white; padding: 20px; border-radius: 8px;">
                <li style="margin: 8px 0;">âœ… <strong>analysis_result.xlsx</strong> - ä¸Šå¸‚è‚¡ç¥¨åˆ†æå ±è¡¨ï¼ˆå®Œæ•´è³‡æ–™ï¼‰</li>
                <li style="margin: 8px 0;">âœ… <strong>otc_analysis_result.xlsx</strong> - ä¸Šæ«ƒè‚¡ç¥¨åˆ†æå ±è¡¨ï¼ˆå®Œæ•´è³‡æ–™ï¼‰</li>
              </ul>
              
              <p style="margin-top: 30px; color: #666; font-size: 12px; text-align: center; padding-top: 20px; border-top: 1px solid #eee;">
                ğŸ¤– æ­¤å ±å‘Šç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿ<br>
                ğŸ“… ç”Ÿæˆæ™‚é–“: {datetime_str}
              </p>
            </body>
          </html>
          """
              
              msg.attach(MIMEText(body, 'html', 'utf-8'))
              
              # é™„åŠ  Excel æª”æ¡ˆ
              files_to_attach = [
                  'StockInfo/analysis_result.xlsx',
                  'StockInfo/otc_analysis_result.xlsx'
              ]
              
              for filename in files_to_attach:
                  if os.path.exists(filename):
                      with open(filename, 'rb') as f:
                          part = MIMEBase('application', 'octet-stream')
                          part.set_payload(f.read())
                          encoders.encode_base64(part)
                          part.add_header(
                              'Content-Disposition',
                              f'attachment; filename= {os.path.basename(filename)}'
                          )
                          msg.attach(part)
                          print(f'âœ… é™„åŠ æª”æ¡ˆ: {filename}')
                  else:
                      print(f'âš ï¸  æª”æ¡ˆä¸å­˜åœ¨: {filename}')
              
              # ç™¼é€éƒµä»¶
              try:
                  server = smtplib.SMTP('smtp.gmail.com', 587)
                  server.starttls()
                  server.login(sender_email, sender_password)
                  server.send_message(msg)
                  server.quit()
                  print(f'âœ… éƒµä»¶å·²æˆåŠŸç™¼é€åˆ°: {recipient_email}')
              except Exception as e:
                  print(f'âŒ éƒµä»¶ç™¼é€å¤±æ•—: {str(e)}')
                  raise
          
          if __name__ == '__main__':
              send_email()
          EOF
          
          # åŸ·è¡Œç™¼é€éƒµä»¶
          python send_email.py
      
      - name: Commit stock data to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ç¢ºä¿ StockInfo è³‡æ–™å¤¾å­˜åœ¨
          mkdir -p StockInfo
          
          # è¤‡è£½ Excel åˆ†æå ±è¡¨åˆ° StockInfo è³‡æ–™å¤¾
          cp -f analysis_result.xlsx StockInfo/ 2>/dev/null || true
          cp -f otc_analysis_result.xlsx StockInfo/ 2>/dev/null || true
          
          # åŠ å…¥æ‰€æœ‰è¦æäº¤çš„æª”æ¡ˆ
          git add -A StockDaily/*.csv \
                     StockShares/*.csv \
                     StockOTCDaily/*.csv \
                     StockOTCShares/*.csv \
                     StockHistory/*.csv \
                     StockOTCHistory/*.csv \
                     StockInfo/*.xlsx 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "âŒ æ²’æœ‰è³‡æ–™è®Šæ›´"
          else
            git commit -m "ğŸ“Š æ›´æ–°è‚¡ç¥¨è³‡æ–™ $(TZ=Asia/Taipei date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… æˆåŠŸæ¨é€è³‡æ–™åˆ° repository"
            echo "   - CSV åŸå§‹è³‡æ–™å·²æ›´æ–°"
            echo "   - Excel åˆ†æå ±è¡¨å·²æ›´æ–° (StockInfo/)"
          fi
      
      - name: Clean old releases (keep last 30 days)
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 30
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}