name: æ¯æ—¥å°è‚¡åˆ†æ (ä½¿ç”¨ GitHub Releases)

on:
  schedule:
    # é€±ä¸€åˆ°é€±äº” UTC 09:00 åŸ·è¡Œ = å°ç£æ™‚é–“ä¸‹åˆ 17:00 (UTC+8)
    - cron: '0 9 * * 1-5'
  
  workflow_dispatch:

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk chromium-browser chromium-chromedriver
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Ensure data directories exist
        run: |
          mkdir -p StockHTML StockPNG StockOTCHTML StockOTCPNG
      
      - name: Run stock analysis
        env:
          TZ: 'Asia/Taipei'
        run: |
          python ä¸Šå¸‚ä¸Šæ«ƒå…¨æµç¨‹.py
      
      - name: Package analysis results
        run: |
          # å‰µå»ºæ—¥æœŸæ¨™è¨˜
          DATE=$(TZ=Asia/Taipei date +'%Y%m%d')
          DATETIME=$(TZ=Asia/Taipei date +'%Y-%m-%d %H:%M')
          
          # æ‰“åŒ…æ‰€æœ‰åˆ†æçµæœ
          mkdir -p release_package
          
          # è¤‡è£½ Excel å ±è¡¨
          cp -f *.xlsx release_package/ 2>/dev/null || true
          
          # è¤‡è£½ HTML å’Œ PNG åœ–è¡¨
          cp -f StockHTML/*.html release_package/ 2>/dev/null || true
          cp -f StockPNG/*.png release_package/ 2>/dev/null || true
          cp -f StockOTCHTML/*.html release_package/ 2>/dev/null || true
          cp -f StockOTCPNG/*.png release_package/ 2>/dev/null || true
          
          # å‰µå»ºå£“ç¸®æª”
          cd release_package
          zip -r ../stock-analysis-${DATE}.zip . -x "*.git*"
          cd ..
          
          echo "DATE=${DATE}" >> $GITHUB_ENV
          echo "DATETIME=${DATETIME}" >> $GITHUB_ENV
          
          # é¡¯ç¤ºæ‰“åŒ…å…§å®¹
          echo "æ‰“åŒ…å…§å®¹:"
          unzip -l stock-analysis-${DATE}.zip | head -20
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: analysis-${{ env.DATE }}
          name: è‚¡ç¥¨åˆ†æå ±å‘Š ${{ env.DATETIME }}
          body: |
            ## ğŸ“Š å°è‚¡åˆ†æå ±å‘Š
            
            **åˆ†ææ™‚é–“:** ${{ env.DATETIME }}
            
            ### ğŸ“¦ ä¸‹è¼‰å…§å®¹
            - âœ… ä¸Šå¸‚åˆ†æå ±è¡¨ (analysis_result.xlsx)
            - âœ… ä¸Šæ«ƒåˆ†æå ±è¡¨ (otc_analysis_result.xlsx)
            - âœ… æ‰€æœ‰ HTML äº’å‹•åœ–è¡¨
            - âœ… æ‰€æœ‰ PNG éœæ…‹åœ–è¡¨
            
            ### ğŸ“ˆ åˆ†ææŒ‡æ¨™
            - æˆäº¤é‡ç•°å¸¸åˆ†æ
            - æ³•äººè²·è³£è¶…çµ±è¨ˆ
            - æ¼²è·Œå¹…æ’è¡Œ
            - æŠ€è¡“æŒ‡æ¨™åˆ†æ
            
            ---
            
            âš ï¸ æ­¤ release æœƒåœ¨ 30 å¤©å¾Œè‡ªå‹•åˆªé™¤
          files: stock-analysis-${{ env.DATE }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit stock data to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add -A StockDaily/*.csv \
                     StockShares/*.csv \
                     StockOTCDaily/*.csv \
                     StockOTCShares/*.csv \
                     StockHistory/*.csv \
                     StockOTCHistory/*.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "âŒ æ²’æœ‰è³‡æ–™è®Šæ›´"
          else
            git commit -m "ğŸ“Š æ›´æ–°è‚¡ç¥¨è³‡æ–™ $(TZ=Asia/Taipei date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… æˆåŠŸæ¨é€è³‡æ–™åˆ° repository"
          fi
      
      - name: Clean old releases (keep last 30 days)
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 30
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}