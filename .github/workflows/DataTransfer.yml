name: Transfer Data to StockTracker

on:
  schedule:
    # æ¯å¤©å°åŒ—æ™‚é–“ä¸‹åˆ6é»åŸ·è¡Œ (UTC+8 = 18:00, UTC = 10:00)
    - cron: '0 10 * * *'  # æ¯å¤©åŸ·è¡Œ
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
  push:
    paths:
      - 'StockInfo/TSE_buy_ranking.txt'
      - 'StockInfo/OTC_buy_ranking.txt'

jobs:
  transfer-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GetDailyStock repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      - name: Check if data files exist
        run: |
          echo "Checking for data files..."
          ls -la StockInfo/
          if [ -f "StockInfo/TSE_buy_ranking.txt" ]; then
            echo "âœ… TSE_buy_ranking.txt found"
          else
            echo "âŒ TSE_buy_ranking.txt not found"
          fi
          if [ -f "StockInfo/OTC_buy_ranking.txt" ]; then
            echo "âœ… OTC_buy_ranking.txt found"
          else
            echo "âŒ OTC_buy_ranking.txt not found"
          fi
      
      - name: Checkout StockTracker repository
        uses: actions/checkout@v3
        with:
          repository: ccupcpop/StockTracker
          token: ${{ secrets.PAT_TOKEN }}
          path: stocktracker
          fetch-depth: 1
      
      - name: Create StockInfo folder if not exists
        run: |
          mkdir -p stocktracker/StockInfo
          echo "StockInfo folder ready"
      
      - name: Copy data files to StockTracker
        run: |
          echo "Copying files to StockTracker/StockInfo..."
          if [ -f "StockInfo/TSE_buy_ranking.txt" ]; then
            cp StockInfo/TSE_buy_ranking.txt stocktracker/StockInfo/
            echo "âœ… Copied TSE_buy_ranking.txt"
          fi
          if [ -f "StockInfo/OTC_buy_ranking.txt" ]; then
            cp StockInfo/OTC_buy_ranking.txt stocktracker/StockInfo/
            echo "âœ… Copied OTC_buy_ranking.txt"
          fi
          ls -la stocktracker/StockInfo/
      
      - name: Commit and push to StockTracker
        run: |
          cd stocktracker
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add StockInfo/*.txt
          
          # ç”Ÿæˆå°åŒ—æ™‚é–“çš„æ™‚é–“æˆ³
          TAIPEI_TIME=$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Update stock data - ${TAIPEI_TIME}"
            git push
            echo "âœ… Successfully pushed to StockTracker"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "================================"
          echo "ğŸ“‹ Transfer Summary"
          echo "================================"
          echo "Source: GetDailyStock/StockInfo"
          echo "Target: StockTracker/StockInfo"
          echo "Files: TSE_buy_ranking.txt, OTC_buy_ranking.txt"
          echo "Time: $(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S') (Taipei)"
          echo "================================"