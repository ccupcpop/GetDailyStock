name: Transfer Data to StockTracker

on:
  schedule:
    # ÊØèÂ§©Âè∞ÂåóÊôÇÈñì‰∏ãÂçà6ÈªûÂü∑Ë°å (UTC+8 = 18:00, UTC = 10:00)
    - cron: '0 10 * * *'  # ÊØèÂ§©Âü∑Ë°å
  workflow_dispatch:  # ÂÖÅË®±ÊâãÂãïËß∏Áôº
  push:
    paths:
      - 'StockInfo/TSE_buy_ranking.txt'
      - 'StockInfo/OTC_buy_ranking.txt'
      - 'StockInfo/ALL_TSE.html'
      - 'StockInfo/ALL_OTC.html'
      - 'StockInfo/tse_analysis_complete.html'
      - 'StockInfo/otc_analysis_complete.html'

jobs:
  transfer-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GetDailyStock repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      - name: Check if data files exist
        run: |
          echo "Checking for data files..."
          ls -la StockInfo/
          if [ -f "StockInfo/TSE_buy_ranking.txt" ]; then
            echo "‚úÖ TSE_buy_ranking.txt found"
          else
            echo "‚ùå TSE_buy_ranking.txt not found"
          fi
          if [ -f "StockInfo/OTC_buy_ranking.txt" ]; then
            echo "‚úÖ OTC_buy_ranking.txt found"
          else
            echo "‚ùå OTC_buy_ranking.txt not found"
          fi
          if [ -f "StockInfo/ALL_TSE.html" ]; then
            echo "‚úÖ ALL_TSE.html found"
          else
            echo "‚ùå ALL_TSE.html not found"
          fi
          if [ -f "StockInfo/ALL_OTC.html" ]; then
            echo "‚úÖ ALL_OTC.html found"
          else
            echo "‚ùå ALL_OTC.html not found"
          fi
          if [ -f "StockInfo/tse_analysis_complete.html" ]; then
            echo "‚úÖ tse_analysis_complete.html found"
          else
            echo "‚ùå tse_analysis_complete.html not found"
          fi
          if [ -f "StockInfo/otc_analysis_complete.html" ]; then
            echo "‚úÖ otc_analysis_complete.html found"
          else
            echo "‚ùå otc_analysis_complete.html not found"
          fi
      
      - name: Checkout StockTracker repository
        uses: actions/checkout@v3
        with:
          repository: ccupcpop/StockTracker
          token: ${{ secrets.PAT_TOKEN }}
          path: stocktracker
          fetch-depth: 1
      
      - name: Create StockInfo folder if not exists
        run: |
          mkdir -p stocktracker/StockInfo
          echo "StockInfo folder ready"
      
      - name: Remove old files in StockTracker
        run: |
          echo "Removing old files from StockTracker/StockInfo..."
          rm -f stocktracker/StockInfo/TSE_buy_ranking.txt
          rm -f stocktracker/StockInfo/OTC_buy_ranking.txt
          rm -f stocktracker/StockInfo/ALL_TSE.html
          rm -f stocktracker/StockInfo/ALL_OTC.html
          rm -f stocktracker/StockInfo/tse_analysis_complete.html
          rm -f stocktracker/StockInfo/otc_analysis_complete.html
          echo "‚úÖ Old files removed"
      
      - name: Copy data files to StockTracker
        run: |
          echo "Copying files to StockTracker/StockInfo..."
          if [ -f "StockInfo/TSE_buy_ranking.txt" ]; then
            cp StockInfo/TSE_buy_ranking.txt stocktracker/StockInfo/
            echo "‚úÖ Copied TSE_buy_ranking.txt"
          fi
          if [ -f "StockInfo/OTC_buy_ranking.txt" ]; then
            cp StockInfo/OTC_buy_ranking.txt stocktracker/StockInfo/
            echo "‚úÖ Copied OTC_buy_ranking.txt"
          fi
          if [ -f "StockInfo/ALL_TSE.html" ]; then
            cp StockInfo/ALL_TSE.html stocktracker/StockInfo/
            echo "‚úÖ Copied ALL_TSE.html"
          fi
          if [ -f "StockInfo/ALL_OTC.html" ]; then
            cp StockInfo/ALL_OTC.html stocktracker/StockInfo/
            echo "‚úÖ Copied ALL_OTC.html"
          fi
          if [ -f "StockInfo/tse_analysis_complete.html" ]; then
            cp StockInfo/tse_analysis_complete.html stocktracker/StockInfo/
            echo "‚úÖ Copied tse_analysis_complete.html"
          fi
          if [ -f "StockInfo/otc_analysis_complete.html" ]; then
            cp StockInfo/otc_analysis_complete.html stocktracker/StockInfo/
            echo "‚úÖ Copied otc_analysis_complete.html"
          fi
          echo ""
          echo "Files in stocktracker/StockInfo:"
          ls -la stocktracker/StockInfo/
      
      - name: Commit and push to StockTracker
        run: |
          cd stocktracker
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add StockInfo/*.txt
          git add StockInfo/*.html
          
          # ÁîüÊàêÂè∞ÂåóÊôÇÈñìÁöÑÊôÇÈñìÊà≥
          TAIPEI_TIME=$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìä Update stock data - ${TAIPEI_TIME}"
            git push
            echo "‚úÖ Successfully pushed to StockTracker"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "================================"
          echo "üìã Transfer Summary"
          echo "================================"
          echo "Source: GetDailyStock/StockInfo"
          echo "Target: StockTracker/StockInfo"
          echo "Files:"
          echo "  - TSE_buy_ranking.txt"
          echo "  - OTC_buy_ranking.txt"
          echo "  - ALL_TSE.html"
          echo "  - ALL_OTC.html"
          echo "  - tse_analysis_complete.html"
          echo "  - otc_analysis_complete.html"
          echo "Time: $(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S') (Taipei)"
          echo "================================"