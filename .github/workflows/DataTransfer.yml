name: Transfer Data to StockTracker and StockTrend

on:
  schedule:
    # æ¯å¤©å°åŒ—æ™‚é–“ä¸‹åˆ6é»žåŸ·è¡Œ (UTC+8 = 18:00, UTC = 10:00)
    - cron: '0 9 * * *'  # æ¯å¤©åŸ·è¡Œ
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
  push:
    paths:
      - 'StockInfo/TSE_buy_ranking.txt'
      - 'StockInfo/OTC_buy_ranking.txt'
      - 'StockInfo/ALL_TSE.html'
      - 'StockInfo/ALL_OTC.html'
      - 'StockInfo/Concept_ALL.html'
      - 'StockInfo/tse_analysis_result_complete.html'
      - 'StockInfo/otc_analysis_result_complete.html'
      - 'ConceptHTML/**'
      - 'StockTSEHistory/**'
      - 'StockOTCHistory/**'

jobs:
  transfer-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GetDailyStock repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      - name: Check if data files exist
        run: |
          echo "Checking for data files..."
          ls -la StockInfo/
          if [ -f "StockInfo/TSE_buy_ranking.txt" ]; then
            echo "âœ… TSE_buy_ranking.txt found"
          else
            echo "âŒ TSE_buy_ranking.txt not found"
          fi
          if [ -f "StockInfo/OTC_buy_ranking.txt" ]; then
            echo "âœ… OTC_buy_ranking.txt found"
          else
            echo "âŒ OTC_buy_ranking.txt not found"
          fi
          if [ -f "StockInfo/ALL_TSE.html" ]; then
            echo "âœ… ALL_TSE.html found"
          else
            echo "âŒ ALL_TSE.html not found"
          fi
          if [ -f "StockInfo/ALL_OTC.html" ]; then
            echo "âœ… ALL_OTC.html found"
          else
            echo "âŒ ALL_OTC.html not found"
          fi
          if [ -f "StockInfo/Concept_ALL.html" ]; then
            echo "âœ… Concept_ALL.html found"
          else
            echo "âŒ Concept_ALL.html not found"
          fi
          if [ -f "StockInfo/tse_analysis_result_complete.html" ]; then
            echo "âœ… tse_analysis_result_complete.html found"
          else
            echo "âŒ tse_analysis_result_complete.html not found"
          fi
          if [ -f "StockInfo/otc_analysis_result_complete.html" ]; then
            echo "âœ… otc_analysis_result_complete.html found"
          else
            echo "âŒ otc_analysis_result_complete.html not found"
          fi
          if [ -d "ConceptHTML" ]; then
            echo "âœ… ConceptHTML folder found"
            echo "ConceptHTML files:"
            ls -la ConceptHTML/
          else
            echo "âŒ ConceptHTML folder not found"
          fi
          
          echo ""
          echo "Checking for database files..."
          if [ -f "StockTSEHistory/stock_tse.db" ]; then
            echo "âœ… stock_tse.db found"
            echo "Size: $(du -h StockTSEHistory/stock_tse.db | cut -f1)"
          else
            echo "âŒ stock_tse.db not found"
          fi
          if [ -f "StockOTCHistory/stock_otc.db" ]; then
            echo "âœ… stock_otc.db found"
            echo "Size: $(du -h StockOTCHistory/stock_otc.db | cut -f1)"
          else
            echo "âŒ stock_otc.db not found"
          fi
          
          echo ""
          echo "Checking for CSV history folders..."
          if [ -d "StockTSEHistory" ]; then
            echo "âœ… StockTSEHistory folder found"
            echo "CSV count: $(find StockTSEHistory -name '*.csv' | wc -l)"
          else
            echo "âŒ StockTSEHistory folder not found"
          fi
          if [ -d "StockOTCHistory" ]; then
            echo "âœ… StockOTCHistory folder found"
            echo "CSV count: $(find StockOTCHistory -name '*.csv' | wc -l)"
          else
            echo "âŒ StockOTCHistory folder not found"
          fi
      
      - name: Checkout StockTracker repository
        uses: actions/checkout@v3
        with:
          repository: ccupcpop/StockTracker
          token: ${{ secrets.PAT_TOKEN }}
          path: stocktracker
          fetch-depth: 1
      
      - name: Create StockInfo folder if not exists
        run: |
          mkdir -p stocktracker/StockInfo
          echo "StockInfo folder ready"
      
      - name: Remove old files in StockTracker
        run: |
          echo "Removing old files from StockTracker/StockInfo..."
          rm -f stocktracker/StockInfo/TSE_buy_ranking.txt
          rm -f stocktracker/StockInfo/OTC_buy_ranking.txt
          rm -f stocktracker/StockInfo/ALL_TSE.html
          rm -f stocktracker/StockInfo/ALL_OTC.html
          rm -f stocktracker/StockInfo/Concept_ALL.html
          rm -f stocktracker/StockInfo/tse_analysis_result_complete.html
          rm -f stocktracker/StockInfo/otc_analysis_result_complete.html
          rm -f stocktracker/StockInfo/stock_tse.db
          rm -f stocktracker/StockInfo/stock_otc.db
          rm -rf stocktracker/ConceptHTML
          echo "âœ… Old files removed"
      
      - name: Copy data files to StockTracker
        run: |
          echo "Copying files to StockTracker/StockInfo..."
          if [ -f "StockInfo/TSE_buy_ranking.txt" ]; then
            cp StockInfo/TSE_buy_ranking.txt stocktracker/StockInfo/
            echo "âœ… Copied TSE_buy_ranking.txt"
          fi
          if [ -f "StockInfo/OTC_buy_ranking.txt" ]; then
            cp StockInfo/OTC_buy_ranking.txt stocktracker/StockInfo/
            echo "âœ… Copied OTC_buy_ranking.txt"
          fi
          if [ -f "StockInfo/ALL_TSE.html" ]; then
            cp StockInfo/ALL_TSE.html stocktracker/StockInfo/
            echo "âœ… Copied ALL_TSE.html"
          fi
          if [ -f "StockInfo/ALL_OTC.html" ]; then
            cp StockInfo/ALL_OTC.html stocktracker/StockInfo/
            echo "âœ… Copied ALL_OTC.html"
          fi
          if [ -f "StockInfo/Concept_ALL.html" ]; then
            cp StockInfo/Concept_ALL.html stocktracker/StockInfo/
            echo "âœ… Copied Concept_ALL.html"
          fi
          if [ -f "StockInfo/tse_analysis_result_complete.html" ]; then
            cp StockInfo/tse_analysis_result_complete.html stocktracker/StockInfo/
            echo "âœ… Copied tse_analysis_result_complete.html"
          fi
          if [ -f "StockInfo/otc_analysis_result_complete.html" ]; then
            cp StockInfo/otc_analysis_result_complete.html stocktracker/StockInfo/
            echo "âœ… Copied otc_analysis_result_complete.html"
          fi
          
          echo ""
          echo "Copying database files to StockTracker/StockInfo..."
          if [ -f "StockTSEHistory/stock_tse.db" ]; then
            cp StockTSEHistory/stock_tse.db stocktracker/StockInfo/
            echo "âœ… Copied stock_tse.db ($(du -h StockTSEHistory/stock_tse.db | cut -f1))"
          fi
          if [ -f "StockOTCHistory/stock_otc.db" ]; then
            cp StockOTCHistory/stock_otc.db stocktracker/StockInfo/
            echo "âœ… Copied stock_otc.db ($(du -h StockOTCHistory/stock_otc.db | cut -f1))"
          fi
          
          echo ""
          echo "Files in stocktracker/StockInfo:"
          ls -la stocktracker/StockInfo/
          
          echo ""
          echo "Copying ConceptHTML folder to StockTracker root..."
          if [ -d "ConceptHTML" ]; then
            cp -r ConceptHTML stocktracker/
            echo "âœ… Copied ConceptHTML folder to StockTracker/"
            echo "ConceptHTML files in target:"
            ls -la stocktracker/ConceptHTML/
          fi
      
      - name: Commit and push to StockTracker
        run: |
          cd stocktracker
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add StockInfo/*.txt
          git add StockInfo/*.html
          git add StockInfo/*.db
          git add ConceptHTML/
          
          # ç”Ÿæˆå°åŒ—æ™‚é–“çš„æ™‚é–“æˆ³
          TAIPEI_TIME=$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update stock data - ${TAIPEI_TIME}"
            git push
            echo "âœ… Successfully pushed to StockTracker"
          fi
      
      - name: Checkout StockTrend repository
        uses: actions/checkout@v3
        with:
          repository: ccupcpop/StockTrend
          token: ${{ secrets.PAT_TOKEN }}
          path: stocktrend
          fetch-depth: 1
      
      - name: Create stock_data folder if not exists
        run: |
          mkdir -p stocktrend/stock_data
          echo "stock_data folder ready"
      
      - name: Summary
        if: always()
        run: |
          echo "================================"
          echo "ðŸ“‹ Transfer Summary"
          echo "================================"
          echo ""
          echo "ðŸ“¦ StockTracker Transfer:"
          echo "  Source: GetDailyStock/StockInfo"
          echo "  Target: StockTracker/StockInfo"
          echo "  Files:"
          echo "    - TSE_buy_ranking.txt"
          echo "    - OTC_buy_ranking.txt"
          echo "    - ALL_TSE.html"
          echo "    - ALL_OTC.html"
          echo "    - Concept_ALL.html"
          echo "    - tse_analysis_result_complete.html"
          echo "    - otc_analysis_result_complete.html"
          echo ""
          echo "  Source: GetDailyStock/StockTSEHistory & StockOTCHistory"
          echo "  Target: StockTracker/StockInfo"
          echo "  Database Files:"
          echo "    - stock_tse.db"
          echo "    - stock_otc.db"
          echo ""
          echo "  Source: GetDailyStock/ConceptHTML"
          echo "  Target: StockTracker/ConceptHTML"
          echo "  Folder: ConceptHTML/ (entire folder)"
          echo ""
          echo "ðŸ“ˆ StockTrend Transfer:"
          echo "  Source: GetDailyStock/StockTSEHistory"
          echo "  Source: GetDailyStock/StockOTCHistory"
          echo "  Target: StockTrend/stock_data"
          echo "  Files: All *.csv files ($(ls -1 stocktrend/stock_data/*.csv 2>/dev/null | wc -l) files)"
          echo ""
          echo "Time: $(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S') (Taipei)"
          echo "================================"